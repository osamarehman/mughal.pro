# Modifying Services

This guide provides instructions on how to modify existing services in the server automation setup. Whether you need to change configurations, update versions, or customize service parameters, this document will help you make those changes safely.

## Table of Contents

1. [General Principles](#general-principles)
2. [Modifying Docker Compose Configuration](#modifying-docker-compose-configuration)
3. [Updating Service Versions](#updating-service-versions)
4. [Customizing Service Configurations](#customizing-service-configurations)
5. [Adding Environment Variables](#adding-environment-variables)
6. [Modifying Resource Limits](#modifying-resource-limits)
7. [Service-Specific Modifications](#service-specific-modifications)
8. [Testing Your Changes](#testing-your-changes)

## General Principles

When modifying services, follow these general principles:

1. **Backup First**: Always backup your configuration before making changes
2. **One Change at a Time**: Make and test one change at a time
3. **Document Changes**: Keep track of what you've modified
4. **Test in Development**: If possible, test changes in a development environment first
5. **Check Logs**: After making changes, check service logs for any errors

## Modifying Docker Compose Configuration

The Docker Compose configuration is generated by the `docker-compose-services.sh` script. To modify the Docker Compose configuration:

1. Edit the `docker-compose-services.sh` script
2. Find the service you want to modify
3. Make your changes to the service definition
4. Run the setup script again with the `--reconfigure` option:
   ```bash
   ./setup.sh --reconfigure
   ```

Example: Adding a volume to the Caddy service

```bash
# Original
cat >> "$output_file" << EOF
  caddy:
    image: caddy:latest
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ${DATA_DIR}/caddy/config/Caddyfile:/etc/caddy/Caddyfile
      - ${DATA_DIR}/caddy/data:/data
      - ${DATA_DIR}/caddy/config:/config
      - ${DATA_DIR}/caddy/site:/srv
EOF

# Modified (adding a new volume)
cat >> "$output_file" << EOF
  caddy:
    image: caddy:latest
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ${DATA_DIR}/caddy/config/Caddyfile:/etc/caddy/Caddyfile
      - ${DATA_DIR}/caddy/data:/data
      - ${DATA_DIR}/caddy/config:/config
      - ${DATA_DIR}/caddy/site:/srv
      - /path/to/custom/files:/custom
EOF
```

## Updating Service Versions

To update a service version:

1. Edit the `docker-compose-services.sh` script
2. Find the service you want to update
3. Change the image tag from `latest` to a specific version or keep `latest` to always use the newest version
4. Run the setup script again with the `--reconfigure` option

Example: Changing Grafana from latest to a specific version

```bash
# Original
grafana:
  image: grafana/grafana:latest

# Modified
grafana:
  image: grafana/grafana:9.5.2
```

## Customizing Service Configurations

Service configurations are generated by the `config-generator.sh` script. To modify a service configuration:

1. Edit the `config-generator.sh` script
2. Find the function that generates the configuration for your service
3. Modify the configuration template
4. Run the setup script again with the `--reconfigure` option

Example: Modifying Redis configuration

```bash
# Original
generate_redis_config() {
    cat > "$1" << EOF
maxmemory 256mb
maxmemory-policy allkeys-lru
EOF
}

# Modified
generate_redis_config() {
    cat > "$1" << EOF
maxmemory 512mb
maxmemory-policy volatile-lru
save 900 1
save 300 10
save 60 10000
EOF
}
```

## Adding Environment Variables

To add environment variables to a service:

1. Edit the `docker-compose-services.sh` script
2. Find the service you want to modify
3. Add the environment variables to the service definition
4. If the variable should be configurable, also update the `generate_env_file` function
5. Run the setup script again with the `--reconfigure` option

Example: Adding environment variables to Vaultwarden

```bash
# Original
environment:
  - ADMIN_TOKEN=${VAULTWARDEN_HASHED_TOKEN}
  - TZ=${TIMEZONE}

# Modified
environment:
  - ADMIN_TOKEN=${VAULTWARDEN_HASHED_TOKEN}
  - TZ=${TIMEZONE}
  - SIGNUPS_ALLOWED=false
  - DOMAIN=https://vault.${domain}
  - SMTP_HOST=${SMTP_HOST}
  - SMTP_PORT=${SMTP_PORT}
  - SMTP_SSL=true
  - SMTP_USERNAME=${SMTP_USERNAME}
  - SMTP_PASSWORD=${SMTP_PASSWORD}
```

## Modifying Resource Limits

To change resource limits for a service:

1. Edit the `setup.sh` script
2. Find the section where default resource limits are set
3. Modify the values for the service you want to change
4. Run the setup script again with the `--reconfigure` option

Example: Changing resource limits for MariaDB

```bash
# Original
MEMORY_LIMITS[mariadb]="1g"
CPU_LIMITS[mariadb]="1"

# Modified
MEMORY_LIMITS[mariadb]="2g"
CPU_LIMITS[mariadb]="2"
```

## Service-Specific Modifications

### Caddy

To modify the Caddyfile:

1. Edit the `generate_caddy_config` function in `config-generator.sh`
2. Update the Caddyfile template
3. Run the setup script again with the `--reconfigure` option

### Authelia

To modify Authelia configuration:

1. Edit the `generate_authelia_config` function in `config-generator.sh`
2. Update the configuration.yml template
3. Run the setup script again with the `--reconfigure` option

To modify the users database:

1. Edit the `generate_authelia_users` function in `config-generator.sh`
2. Update the users_database.yml template
3. Run the setup script again with the `--reconfigure` option

### Databases (MariaDB/PostgreSQL)

To modify database configuration:

1. Edit the respective configuration generation function in `config-generator.sh`
2. Update the configuration template
3. Run the setup script again with the `--reconfigure` option

Note: Changing database configurations may require data migration. Always backup your data first.

## Testing Your Changes

After making changes:

1. Run the setup script with the `--reconfigure` option
2. Check that the service starts correctly:
   ```bash
   docker compose -f /opt/docker/compose/docker-compose.yml ps
   ```
3. Check the logs for any errors:
   ```bash
   docker compose -f /opt/docker/compose/docker-compose.yml logs [service_name]
   ```
4. Test the functionality of the service

If you encounter issues, you can revert to the previous configuration by restoring from your backup.
